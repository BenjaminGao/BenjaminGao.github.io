---
layout:     post
title:      关于在使用 Clash 过程中遇到的问题
subtitle:   
date:       2019-02-05
author:     benjamingao
header-img: img/clash.png
catalog: true
tags:
    - 翻墙
    - ss
    - 代理
---

# 关于在使用 Clash 过程中遇到的问题

## 前言

本人太笨，在使用 `clash for windows` 和 `clashx` 遇到了一系列问题，现在记录下来以便供自己和遇到相同问题的人以参考。

__此篇文章针对的是 ss，不是 V2。建议看完全文再实际操作。__

---

## ClashX && clash for windows

### 软件下载、安装以及简单使用

#### 下载

此处略，谷歌搜索名字，GitHub 上面的就是。

#### 安装

此处略，安装也没什么好说的。

#### 配置文件

- `ClashX` 的配置文件在 `~/.config/clash`
- `clash for windows` 的配置文件在 `C:\Users\你的用户名\.config\clash`，如果找不到就是进 C 盘，点击 用户，点击文件夹是你用户名的文件夹，进去之后点击 .config 文件夹，再点 clash 文件夹，就看到 config.yaml 文件了。

#### 编辑配置文件

macOS 好说，用默认的文本编辑就能打开，Win 推荐用 vscode 之类的软件。

### 代理节点修改

配置文件有很多东西，先说 `Proxy` 这里面的东西：

```yaml
#此为示例：
Proxy:
  - server: www.google.com      #此为（代理）服务器地址，填写 URL 或者 IP
    name: 香港                   #此为服务器在 ClashX 里显示的名字，比如上面的服务器是香港的，你就在这里把 US01 替换成“香港”
    port: 12345                 #此为服务器的端口，不是你的本机端口，本机端口一般为 1080，1081，1086 这些
    password: password          #此为节点连接密码
    cipher: aes-256-cfb         #此为加密方式 [1]，在 gui-config.json 里是 cipher 被写成 method
    obfs: tls                   #simple_obfs_tls 写为 tls, 或者 obfs_tls 同样写为 tls
    obfs-host: www.bing.com     #参数，你的是什么就写什么
    type: ss                    #填写 ss，V2 的话去 clashX 的 GitHub 去看配置
```

配置文件或 GitHub 应该是这么写的：

```yaml
Proxy:
- { name: "ss1", type: ss, server: server, port: 443, cipher: AEAD_CHACHA20_POLY1305, password: "password" }
```

配置文件或 GitHub 这种写法两侧有大括号，不过他们的 __作用__ 是一样的，也就是说他们的区别只是两种 __表现形式__。下边说 Proxy Group，配置文件或 GitHub 的内容是这样的：

```yaml
Proxy Group:
# url-test select which proxy will be used by benchmarking speed to a URL.
- { name: "auto", type: url-test, proxies: ["ss1", "ss2", "vmess1"], url: "http://www.gstatic.com/generate_204", interval: 300 }

# fallback select an available policy by priority. The availability is tested by accessing an URL, just like an auto url-test group.
- { name: "fallback-auto", type: fallback, proxies: ["ss1", "ss2", "vmess1"], url: "http://www.gstatic.com/generate_204", interval: 300 }

# select is used for selecting proxy or proxy group
# you can use RESTful API to switch proxy, is recommended for use in GUI.
- { name: "Proxy", type: select, proxies: ["ss1", "ss2", "vmess1", "auto"] }
```

我们让它变成这样就可以了：

```yaml
Proxy Group:
- { name: "auto", type: url-test, proxies: ["香港" ], url: "http://www.gstatic.com/generate_204", interval: 300 }
- { name: "Proxy", type: select, proxies: ["香港", "auto"] }
```

为了跟最上面的一样，我们再把它写成：

```yaml
Proxy Group:
  - name: AUTO                  #这只是个名字，你可以写成 abcd 随意，你写完你知道是做什么的就行
    type: url-test              #这是一个类型，它可以给 abcd 赋予一个功能，你可以这么理解：就像一个房子，我可以赋予一个功能，用来住人。在这里 abcd 就是房子，我们赋予房子一个功能，这个功能就是测各个节点到你的电脑的延迟，写到这上面就是 url-test。
    proxies:                    #一个房子总有各个区间吧，有客厅，有厨房，有卧室。对应的，你可能会有很多节点，香港，日本，美国等等，你就把 Proxy 里的各个 name 写到下边，要完全一样 
      - 香港 1
      - 香港 2
      - 日本 1
    url: 'http://www.gstatic.com/generate_204' #这个就是用来测试的网址了，你总得有目标对吧，得从你的电脑到目标，这个目标就是 url 的参数，也就是冒号后面的网址，用这个就行
    interval: 300               #延迟系数

  - name: PROXY                 #不用我再介绍了吧，写什么都行，最好是写出这是做什么的。先不建议更改，建议先写 PROXY，下边会用到
    type: select                #你可能有很多节点，你总得选择吧，在下边把所有的节点的名字写上，直接复制上面测试延迟的就行
    proxies:
      - 香港
```

除了 Proxy 和 Proxy Group，剩下的参数完全可以找网上的，复制粘贴即可。还有一点就是 Proxy 和 Proxy Group 的缩进要注意，比如说本来 `- name` 前边是两个空格，你别整四个空格就行。

剩下的参数不用管，你先把 Proxy 和 Proxy Group 填好，然后保存文件，此时右上角应该会弹出通知，点一下，然后又弹出一个，这个通知你要看好了，如果有 success 这个单词就代表配置文件没问题了。

点击桌面最上面的这个软件的图标，选择 __控制台__，然后看弹出的窗口中，有代理两个字，然后看下边的一个个节点，五颜六色的都是节点，并且下边会显示多少 ms，也就是多少延迟的意思。

![](https://ws1.sinaimg.cn/large/005Fm2E0ly1g087rvohquj30pk0kdjvj.jpg)

![一个有延迟，一个没有](https://ws1.sinaimg.cn/large/005Fm2E0ly1g087qyp8cyj306p081aab.jpg)

如果没有写数字的，会是灰色的。这种节点不代表不能用，有可能是禁 `Ping` 了，所有你就显示灰色，到底能不能用还是要测试的。

![选择全局连接](https://ws1.sinaimg.cn/large/005Fm2E0ly1g087vk96jpj309101tdfz.jpg)

![GLOBAL 里选择一个节点](https://ws1.sinaimg.cn/large/005Fm2E0ly1g087zmsxm8j305e07w74y.jpg)

选择 __出站模式__，点击然后选择 __全局连接__。打开浏览器，看能不能打开谷歌。如果能，上面的配置文件也没写错，应该是能打开谷歌的。除非有特殊情况，特殊情况特殊处理，这里也无法详细说，毕竟不知道到底是什么特殊情况，比如说节点被封。

win 用户打开软件，然后选择 General，点击 System Proxy 右侧的方框即可。点击 Proxies，点击 Global，选择一个节点然后进行翻墙测试。延迟测试则是点击 Proxies，然后点击 Direct 下边的 Test Latency。

### 规则部分

规则部分就是分流了，类似 Pac 这个功能。这部分照搬网上的整理好的规则就可以了。谷歌 `surge 规则`、`clash 规则` 等等都可以，搜出来之后前几个都是 GitHub 上的，按其下的说明，然后下载就可以了。我这里以我随便搜出来的规则举例，__注意，我是举例[2]，__ 不是说在建议你用这个规则，我自己用的也不是这个规则，具体用哪个规则你们自己尝试吧。

```yaml
# 2019-01-22 23:13:14
#---------------------------------------------------#
## 配置文件需要放置在 $HOME/.config/clash/config.yml
## 
## 如果您不知道如何操作，请参阅 SS-Rule-Snippet 的 Wiki： https://github.com/Hackl0us/SS-Rule-Snippet/wiki/clash(X)
#---------------------------------------------------#

# HTTP 代理端口
port: 7890

# SOCKS5 代理端口
socks-port: 7891

# Linux 和 macOS 的 redir 代理端口 (如需使用此功能，请取消注释)
# redir-port: 7892

# 允许局域网的连接（可用来共享代理）
allow-lan: false

# 规则模式：Rule（规则） / Global（全局代理）/ Direct（全局直连）
mode: Rule

# 设置日志输出级别 (默认级别：silent，即不输出任何内容，以避免因日志内容过大而导致程序内存溢出）。
# 5 个级别：silent / info / warning / error / debug。级别越高日志输出量越大，越倾向于调试，若需要请自行开启。
log-level: silent

# clash 的 RESTful API
external-controller: 127.0.0.1:9090

# 您可以将静态网页资源（如 clash-dashboard）放置在一个目录中，clash 将会服务于 `${API}/ui`
# 参数应填写配置目录的相对路径或绝对路径。
# external-ui: folder

# RESTful API 的口令 (可选)
secret: ""

dns:
  enable: true
  ipv6: false
  # listen: 0.0.0.0:53
  # enhanced-mode: redir-host
  nameserver:
     - 1.2.4.8
     - 114.114.114.114
     - 223.5.5.5
     - tls://dns.rubyfish.cn:853
     
  fallback: # 与 nameserver 内的服务器列表同时发起请求，当规则符合 GEOIP 在 CN 以外时，fallback 列表内的域名服务器生效。
     - tls://dns.rubyfish.cn:853
     - tls://dns.google

# clash DNS 请求逻辑：
# (1) 当访问一个域名时， nameserver 与 fallback 列表内的所有服务器并发请求，得到域名对应的 IP 地址。
# (2) clash 将选取 nameserver 列表内，解析最快的结果。
# (3) 若解析结果中，IP 地址属于 国外，那么 clash 将选择 fallback 列表内，解析最快的结果。
#
# 因此，我在 nameserver 和 fallback 内都放置了无污染、解析速度较快的国内 DNS 服务器，以达到最快的解析速度。
# 但是 fallback 列表内服务器会用在解析境外网站，为了结果绝对无污染，我仅保留了支持 DoT/DoH 的两个服务器。
# 
# 注意：
# (1) 如果您为了确保 DNS 解析结果无污染，请仅保留列表内以 tls:// 开头的 DNS 服务器，但是通常对于国内没有太大必要。
# (2) 如果您不在乎可能解析到污染的结果，更加追求速度。请将 nameserver 列表的服务器插入至 fallback 列表内，并移除重复项。

Proxy:

# shadowsocks
# 所支持的加密方式与 go-shadowsocks2 保持一致
# 支持加密方式： AEAD_AES_128_GCM AEAD_AES_192_GCM AEAD_AES_256_GCM AEAD_CHACHA20_POLY1305 AES-128-CTR AES-192-CTR AES-256-CTR AES-128-CFB AES-192-CFB AES-256-CFB CHACHA20-IETF XCHACHA20 
# clash 额外支持 chacha20 rc4-md5 xchacha20-ietf-poly1305 加密方式

- { name: "ss1", type: ss, server: "server", port: 443, cipher: AEAD_CHACHA20_POLY1305, password: "password" }
- { name: "ss2", type: ss, server: "server", port: 443, cipher: AEAD_CHACHA20_POLY1305, password: "password", obfs: tls, obfs-host: "bing.com" }

# vmess
# 支持加密方式：auto / aes-128-gcm / chacha20-poly1305 / none
- { name: "vmess", type: vmess, server: server, port: 443, uuid: uuid, alterId: 32, cipher: auto }
#   tls
- { name: "vmess", type: vmess, server: server, port: 443, uuid: uuid, alterId: 32, cipher: auto, tls: true }
#   tls (skip-cert-verify)
- { name: "vmess", type: vmess, server: server, port: 443, uuid: uuid, alterId: 32, cipher: auto, tls: true, skip-cert-verify: true }
#   ws-path + ws-headers
- { name: "vmess", type: vmess, server: server, port: 443, uuid: uuid, alterId: 32, cipher: auto, network: ws, ws-path: /path, ws-headers: { Host: v2ray.com } }
#   ws + tls
- { name: "vmess", type: vmess, server: server, port: 443, uuid: uuid, alterId: 32, cipher: auto, network: ws, ws-path: /path, tls: true }


#   socks5
- { name: "socks", type: socks5, server: server, port: 443 }
#   socks5 with authentication
- { name: "socks", type: socks5, server: server, port: 443, username: "username", password: "password" }
#   tls
- { name: "socks", type: socks5, server: server, port: 443, tls: true }
#   tls (skip-cert-verify)
- { name: "socks", type: socks5, server: server, port: 443, tls: true, skip-cert-verify: true }

#   http
- { name: "http", type: http, server: server, port: 443 }
#   http with authentication
- { name: "http", type: http, server: server, port: 443, username: "username", password: "password" }
#   tls (https)
- { name: "http", type: http, server: server, port: 443, tls: true }
#   tls (https)  (skip-cert-verify)
- { name: "http", type: http, server: server, port: 443, tls: true, skip-cert-verify: true }

Proxy Group:
# url-test 可以自动选择与指定 URL 测速后，延迟最短的服务器
- { name: "auto", type: url-test, proxies: ["ss1", "ss2", "vmess1"], url: "https://www.bing.com", interval: 300 }

# fallback 可以尽量按照用户书写的服务器顺序，在确保服务器可用的情况下，自动选择服务器
- { name: "fallback-auto", type: fallback, proxies: ["ss1", "ss2", "vmess1"], url: "https://www.bing.com", interval: 300 }

# select 用来允许用户手动选择 代理服务器 或 服务器组
# 您也可以使用 RESTful API 去切换服务器，这种方式推荐在 GUI 中使用
- { name: "Proxy", type: select, proxies: ["ss1", "ss2", "vmess1", "auto"] }

Rule:
...
```

具体分流部分，也就是 `Rule` 这个节点的部分我用省略号代替了，因为没什么要说的。上面的部分说一下。

下载到规则后，把下载的规则里面的 `Proxy` 和 `Proxy Group` 部分全删除，粘贴上你自己的代理节点，就是上面的说的那些，然后其他的就没必要动了，保存，然后复制到相应位置即可。

## 结尾

一个废话连篇的小教程到这里就结束了，平时用规则就可以，不必全局。

![](https://ws1.sinaimg.cn/large/005Fm2E0ly1g0885g3pfhj309001taaa.jpg)

![](https://ws1.sinaimg.cn/large/005Fm2E0ly1g08873kdr9j30jq06xjsb.jpg)

---

1: https://github.com/yichengchen/clashX: 支持的加密方式：AEAD_AES_128_GCM AEAD_AES_192_GCM AEAD_AES_256_GCM AEAD_CHACHA20_POLY1305 AES-128-CTR AES-192-CTR AES-256-CTR AES-128-CFB AES-192-CFB AES-256-CFB CHACHA20-IETF XCHACHA20

2: https://github.com/Hackl0us/SS-Rule-Snippet
